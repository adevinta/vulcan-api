# Copyright 2022 Adevinta
asyncapi: 2.4.0
info:
  title: Vulcan
  version: v0.0.2
servers:
  production:
    url: broker.example.com
    protocol: kafka
    description: Dummy server.
defaultContentType: application/json
channels:
  assets:
    description: CDC Events of the assets stored in Vulcan.
    subscribe:
      message:
        $ref: '#/components/messages/asset'
  findings:
    subscribe:
      message:
        $ref: '#/components/messages/FindingPayload'

components:
  messages:
    asset:
      name: Asset
      title: Asset state
      summary: |
        Contains the state of an asset as it was stored in a point
        of time in Vulcan.
      headers: 
        $ref: "#/components/schemas/assetMetadata"
      contentType: application/json
      payload:
        $ref: "#/components/schemas/assetPayload"
    FindingPayload:
      contentType: application/json
      headers:
        properties:
          version:
            description: schema version header
            type: string
        required:
        - version
        type: object
      payload:
        $ref: '#/components/schemas/FindingPayload'
      summary: Events generated from Vulnerability DB findings state changes
      name: Finding
      title: Findings state

  schemas:
    assetMetadata:
        type: object
        additionalProperties: false
        properties:
          identifier:
            type: string
          type: 
            $ref: "#/components/schemas/assetType"
          version:
            type: string
            description: The value of this field is equal to the value of the field info.version of this document.
        required:
          - identifier
          - type
          - version
            
    assetPayload:
      type: object
      additionalProperties: false
      properties:
        id:
          type: string
          format: uuid
        team:
          $ref: "#/components/schemas/team"
        alias:
          type: string
        rolfp:
          type: string
        scannable:
          type: boolean
        asset_type:
          $ref: "#/components/schemas/assetType"
        identifier:
          type: string
        annotations:
          type: array
          items:
            - $ref: "#/components/schemas/annotation"
      required:
        - id
        - team
        - alias
        - rolfp
        - scannable
        - asset_type
        - identifier
        - annotations

    assetType:
      type: string
      # Update when the assets types accepted by Vulcan are updated.
      enum:
        - IP
        - DomainName
        - Hostname
        - AWSAccount
        - IPRange
        - DockerImage
        - WebAddress
        - GitRepository

    annotation:
      type: object
      additionalProperties: false
      properties:
        key:
          type: string
        value:
          type: string
      required:
        - key
        - value

    team:
      type: object
      additionalProperties: false
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
        description:
          type: string
        tag:
          type: string
      required:
        - id
        - name
        - description
        - tag
    
    FindingPayload:
      properties:
        affected_resource:
          type: string
        current_exposure:
          type: integer
        details:
          type: string
        id:
          type: string
        impact_details:
          type: string
        issue:
          $ref: '#/components/schemas/StoreIssueLabels'
        resources:
          $ref: '#/components/schemas/StoreResources'
        score:
          type: number
        source:
          $ref: '#/components/schemas/StoreSource'
        status:
          type: string
        target:
          $ref: '#/components/schemas/StoreTargetTeams'
        total_exposure:
          type: integer
      type: object
    PqStringArray:
      items:
        type: string
      type:
      - array
      - "null"
    StoreIssueLabels:
      properties:
        cwe_id:
          minimum: 0
          type: integer
        description:
          type: string
        id:
          type: string
        labels:
          items:
            type: string
          type:
          - array
          - "null"
        recommendations:
          $ref: '#/components/schemas/PqStringArray'
        reference_links:
          $ref: '#/components/schemas/PqStringArray'
        summary:
          type: string
      type: object
    StoreResourceGroup:
      properties:
        attributes:
          items:
            type: string
          type:
          - array
          - "null"
        name:
          type: string
        resources:
          items:
            additionalProperties:
              type: string
            type: object
          type:
          - array
          - "null"
      type: object
    StoreResources:
      items:
        $ref: '#/components/schemas/StoreResourceGroup'
      type:
      - array
      - "null"
    StoreSource:
      properties:
        component:
          type: string
        id:
          type: string
        instance:
          type: string
        name:
          type: string
        options:
          type: string
        time:
          format: date-time
          type: string
      type: object
    StoreTargetTeams:
      properties:
        id:
          type: string
        identifier:
          type: string
        teams:
          items:
            type: string
          type:
          - array
          - "null"
      type: object
